# =============================================================================
# SNI Proxy (port 443)
# L4 proxy - routes TLS by SNI without termination
# Devices see the original Ubiquiti certificate
# =============================================================================

stream {
    resolver 8.8.8.8 1.1.1.1 valid=300s ipv6=off;
    resolver_timeout 5s;

    # Route by SNI hostname
    map $ssl_preread_server_name $upstream {
        fw-download.ubnt.com                fw-download.ubnt.com:443;
        fw-update.ubnt.com                  fw-update.ubnt.com:443;
        fw-update.ui.com                    fw-update.ui.com:443;
        fw-download.ui.com                  fw-download.ui.com:443;
        apt.artifacts.ui.com                apt.artifacts.ui.com:443;

        # Release Candidate / Beta
        apt-release-candidate.artifacts.ui.com  apt-release-candidate.artifacts.ui.com:443;
        apt-beta.artifacts.ui.com               apt-beta.artifacts.ui.com:443;

        # Optional: proxy unknown SNI to another server
        # default                 your-server:443;
    }

    # Log only Ubiquiti domains
    map $ssl_preread_server_name $log_ui {
        fw-download.ubnt.com                1;
        fw-update.ubnt.com                  1;
        fw-update.ui.com                    1;
        fw-download.ui.com                  1;
        apt.artifacts.ui.com                1;
        apt-release-candidate.artifacts.ui.com  1;
        apt-beta.artifacts.ui.com           1;
        default                             0;
    }

    log_format stream_ui
        '$time_iso8601 '
        '$remote_addr '
        'sni="$ssl_preread_server_name" '
        'upstream="$upstream_addr" '
        'bytes_sent=$bytes_sent '
        'bytes_received=$bytes_received '
        'time=$session_time';

    access_log /var/log/nginx/stream.log stream_ui if=$log_ui;

    server {
        listen 443;
        listen [::]:443;
        proxy_pass $upstream;
        ssl_preread on;

        proxy_connect_timeout 30s;
        proxy_timeout 600s;
    }
}
