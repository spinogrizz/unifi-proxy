# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

–Ø —Å–¥–µ–ª–∞–ª —ç—Ç–æ—Ç –ø—Ä–æ–∫—Å–∏, —á—Ç–æ–±—ã –¥—Ä—É–∑—å—è–º –∏ –∑–Ω–∞–∫–æ–º—ã–º –±—ã–ª–æ –ø—Ä–æ—â–µ –ø–æ–ª—É—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UniFi –±–µ–∑ VPN –∏ –ª–∏—à–Ω–µ–π –≤–æ–∑–Ω–∏. –≠—Ç–æ –Ω–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–∏—Å ‚Äî —Å–∫–æ—Ä–µ–µ —Å–ø–æ—Å–æ–± –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –ø–æ–ª–µ–∑–Ω—ã–º –∏ —É–±—Ä–∞—Ç—å –≥–æ–ª–æ–≤–Ω—É—é –±–æ–ª—å —Å –ø—Ä–æ—à–∏–≤–∫–∞–º–∏ –≤ –†–æ—Å—Å–∏–∏. –ù–∏–∂–µ ‚Äî —á—Ç–æ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –ø–æ—á–µ–º—É —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ.

---

### üîê¬†¬†–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ SNI

–≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π. Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ L4 –∏ –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç TLS. –û–Ω —á–∏—Ç–∞–µ—Ç SNI –∏–∑ TLS ClientHello –∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ—Ç TCP –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω Ubiquiti. –î–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Ubiquiti ‚Äî —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–∞—Å—Ç–æ—è—â–∏–π, TLS end‚Äëto‚Äëend.


```nginx
stream {
    resolver 8.8.8.8 1.1.1.1 valid=300s ipv6=off;

    map $ssl_preread_server_name $upstream {
        fw-download.ubnt.com                    fw-download.ubnt.com:443;
        fw-update.ubnt.com                      fw-update.ubnt.com:443;
        fw-update.ui.com                        fw-update.ui.com:443;
        fw-download.ui.com                      fw-download.ui.com:443;
        apt.artifacts.ui.com                    apt.artifacts.ui.com:443;
        apt-release-candidate.artifacts.ui.com  apt-release-candidate.artifacts.ui.com:443;
        apt-beta.artifacts.ui.com               apt-beta.artifacts.ui.com:443;
    }

    server {
        listen 443;
        proxy_pass $upstream;
        ssl_preread on;
    }
}
```



---



### üåê¬†¬†–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫

–≠—Ç–æ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è. –û–Ω –Ω—É–∂–µ–Ω, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª –ø–æ URL –∏ –ø–µ—Ä–µ–¥–∞—Ç—å –µ–≥–æ –≤ Manual Firmware Upgrade –∏–ª–∏ —á–µ—Ä–µ–∑ SSH.

–§–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏:

```
https://unifi.gryzlov.com/fw-download.ubnt.com/path/to/file
```

Nginx –∑–∞–±–∏—Ä–∞–µ—Ç –¥–æ–º–µ–Ω –∏–∑ –ø—É—Ç–∏ –∏ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π HTTPS‚Äë—Ö–æ—Å—Ç, –≤–∫–ª—é—á–∞—è SNI.


```nginx
location ~ ^/(?<target_domain>[^/]+\.(ui|ubnt)\.com)/(?<target_path>.+)$ {
    proxy_pass https://$target_domain/$target_path;
    proxy_ssl_server_name on;
}
```


---


### üîí¬†¬†–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

–¢—É—Ç –Ω–µ—Ç MITM, –Ω–µ—Ç –ø–æ–¥–º–µ–Ω—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞, –Ω–µ—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞. UniFi –Ω–µ –æ—Ç–ª–∏—á–∞–µ—Ç —ç—Ç–æ –æ—Ç –ø—Ä—è–º–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ï—Å–ª–∏ –±—ã –ø–æ–¥–º–µ–Ω—è–ª—Å—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç, —Ç–æ Ubiquiti —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å—Ä–∞–∑—É –∂–µ –±—ã –∑–∞–º–µ—Ç–∏–ª–æ, —á—Ç–æ –¥–æ–º–µ–Ω –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É.

–ú–æ–∂–Ω–æ —É–±–µ–¥–∏—Ç—Å—è –≤ —ç—Ç–æ–º, –ø–æ–¥–∫–ª—é—á–∏–≤—à–∏—Å—å –∫ –º–æ–µ–º—É –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ **openssl** –∏ –ø–æ—Å–º–æ—Ç—Ä–µ–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç:

```bash
openssl s_client -connect fw-download.ubnt.com:443 -servername fw-download.ubnt.com </dev/null 2>/dev/null | openssl x509 -noout -issuer -subject
```